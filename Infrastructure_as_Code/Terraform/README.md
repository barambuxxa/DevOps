#Terraform
Terraform — это инструмент инфраструктуры как кода (IaC) от HashiCorp, который позволяет декларативно описывать и управлять облачными ресурсами, серверами, сетями и другими компонентами инфраструктуры.
Отлично работает в связки с Ansible. Terraform создаёт инфраструктуру (серверы, сети, БД), Ansible настраивает эти серверы (устанавливает ПО, настраивает приложения).


Написание кода Terraform будет осуществляться в IDE VS Code.
На компьютере с ОС Windows 11.

Terraform для связи с Proxmox потребуется провайдер, telmate/proxmox. Нужную версию можно скачать по ссылке: https://github.com/Telmate/terraform-provider-proxmox/releases

Я буду использовать версию v3.0.2-rc04.exe, для Windows x64.
Мне так же потребуется сам Terraform, скачать нужную версию можно с зеркала: 
https://mirror.selectel.ru/3rd-party/hashicorp-releases/terraform/
Я буду использовать версию Terraform v1.11.4
Мы будем использовать Terraform Module для более удобной настройки наших VM. Это даст нам возможность в дальнейшем легче менять код для обновлений. А также разворачивать VM с нужными нами значениями.

Заранее оговорюсь:
В коде уже будет добавлен public key Ansible-сервера. Ansible сервер будет настроен позже. 
Файлы с расширением .tfvars не должны выгружаться в репозиторий, так как там хранится конфиденциальная информация. 

Начнём, написания кода:
1. Создаём директорию terraform_project, в ней будет собираться весь проект.
Структура будет иметь аналогичный вид как в репозитории.
2. Создаём в корне и в каталоге modules/vm файл provider.tf.
В нём будет инициализирован плагин для подключения к proxmox. Так как мы будем использовать не официальный плагин от HashiCorp, то настройки плагина не будут наследоваться в модули. Поэтому нам надо будет создать provider.tf в корне и в каталоге vm.
3. Мы инициализировали плагин для подключения к Proxmox, теперь нам необходимо пройти аутентификацию. Для этого создаём файл variables.tf в корне и создаём переменные для подключения. Значения мы туда вносить не будем, мы вынесем их отдельно в файл terraform.tfvars, так как они являются конфиденциальными.
В файле terraform.tfvars будут указаны следующие значения:
- pm_api_url             - Тут вводится url api нашего Proxmox сервера в сети
- pm_api_token_id        - Тут мы вводим token_id который сформировался при генерации токена. Смотреть настройку Proxmox
- pm_api_token_secret    - Тут вводим token_secret полученный при генерации токена. Смотреть настройку Proxmox
- pm_tls_insecure        - Тут ставим значение true (Отключить проверку SSL\TLS сертификата) или false (Включить проверку по SSL\TLS сертификату)
4. Чтобы эти данные не загрузились в репозиторий, создаём в корне файл .gitignore
5. Переходим к написанию кода для развёртки одной VM. Мы будем делать это через модуль. Сперва будет расписан процесс создания одной VM. После этого мы увидим, какие переменные мы можем вынести. А потом уже на основе этого модуля можем создавать любое количество VM с необходимыми нам параметрами.
Создаём файл main.tf в каталоге modules/vm

6. Мы не сможем прописывать жёстко значения при каждом создании VM. Поэтому выносим значения в файл variables.tf.
7. Вывод для нашего инженера.
Так как все эти значения используются в модуле, нам надо связать их с Output в корне. Для этого нужные значения прописываются в файле modules/vm/outputs.tf.
На этом мы закончили настройку модуля, с его помощью мы можем разворачивать любое количество VM под наши задачи.
8. Добавим 4 переменных с дефолтными значениями в файл variables.tf в корне.
- vm_username
- gateway
- disk_size
- template_name
9. Используя написанный модуль, мы развернём 5 VM на Proxmox для последующей настройки инфраструктуры. В файле main.tf, в корне.
10. Сделаем красивый вывод для нашего инженера, В корне создаём файл Outputs.tf

11. Приступим к развёртки
- terraform init
- terraform plan
- terraform apply

- Мы должны получить 6 рабочикх VM для последующей настройки:
Ansible server, k8sMaster, WorkNode1, WorkNode2, Jenkins server, Jenkins Agent.
- Приступим к настройке серверов.


